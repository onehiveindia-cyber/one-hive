<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="One_Hive - Tab.png">
    <title>OneHive | Forgot Password</title>
    <!-- Plus Jakarta Sans for premium SaaS typography -->
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-init.js"></script>

    <!-- EmailJS for sending emails (Free tier) -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        // TODO: Replace with your actual EmailJS Public Key if you set it up
        (function () {
            emailjs.init("YOUR_EMAILJS_PUBLIC_KEY");
        })();
    </script>

    <style>
        :root {
            --bg-base: #050b14;
            --bg-gradient: radial-gradient(circle at 10% 90%, rgba(37, 99, 235, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 90% 10%, rgba(37, 99, 235, 0.05) 0%, transparent 40%);
            --text-primary: #FFFFFF;
            --text-secondary: #9CA3AF;
            --accent: #3B82F6;
            --accent-hover: #2563EB;
            --danger: #EF4444;
            --success: #10B981;
            --surface: rgba(255, 255, 255, 0.02);
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-active: rgba(59, 130, 246, 0.5);
            --radius-md: 12px;
            --radius-lg: 24px;
            --radius-pill: 9999px;
            --font-sans: 'Plus Jakarta Sans', sans-serif;
        }

        :root.light-theme {
            --bg-base: #ffffff;
            --bg-gradient: radial-gradient(circle at 80% -20%, rgba(249, 115, 22, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 20% 100%, rgba(249, 115, 22, 0.04) 0%, transparent 40%);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --surface: rgba(0, 0, 0, 0.03);
            --border-subtle: rgba(0, 0, 0, 0.08);
            --border-active: rgba(249, 115, 22, 0.5);
        }

        /* --- MODERN GLOBAL SCROLLBAR --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, var(--accent), var(--accent-hover));
            border-radius: 10px;
            border: 2px solid var(--bg-base);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-hover);
        }

        .theme-toggle {
            position: fixed;
            top: 24px;
            right: 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
            z-index: 1000;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        :root.light-theme .theme-toggle {
            background: rgba(0, 0, 0, 0.05);
        }

        :root.light-theme .theme-toggle:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-sans);
            -webkit-font-smoothing: antialiased;
        }

        body {
            background-color: var(--bg-base);
            background-image: var(--bg-gradient);
            background-attachment: fixed;
            background-size: cover;
            background-repeat: no-repeat;
            color: var(--text-primary);
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            position: relative;
            overflow-x: hidden;
        }

        /* Ambient floating shapes */
        .ambient-shape-1 {
            position: absolute;
            top: -10%;
            right: -5%;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            z-index: -1;
        }

        .ambient-shape-2 {
            position: absolute;
            bottom: -10%;
            left: -5%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
            border-radius: 50%;
            z-index: -1;
        }

        .box {
            background: var(--surface);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            padding: 56px 48px;
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 440px;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-subtle);
            position: relative;
            z-index: 10;
        }

        :root.light-theme .box {
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.05);
        }

        h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 32px;
            font-weight: 600;
            letter-spacing: -0.02em;
            line-height: 1.1;
        }

        h2 i {
            color: var(--accent);
            font-style: normal;
            font-weight: 300;
        }

        .subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 32px;
            line-height: 1.5;
        }

        .input-group {
            position: relative;
            margin-bottom: 20px;
            text-align: left;
        }

        input {
            width: 100%;
            padding: 16px 20px;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            font-size: 15px;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.3s ease;
            outline: none;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        :root.light-theme input {
            background: rgba(0, 0, 0, 0.02);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        input::placeholder {
            color: #6B7280;
            font-weight: 400;
        }

        input:focus {
            border-color: var(--border-active);
            background: rgba(255, 255, 255, 0.04);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1), inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        button {
            width: 100%;
            padding: 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius-pill);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            margin-top: 16px;
            transition: 0.3s;
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(59, 130, 246, 0.3);
        }

        button:disabled {
            background: var(--border-subtle);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        p {
            font-size: 14px;
            margin-top: 32px;
            color: var(--text-secondary);
        }

        a {
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 600;
            transition: 0.3s;
        }

        a:hover {
            color: var(--accent);
        }

        .home-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 32px;
            color: var(--text-secondary);
            font-size: 13px;
            text-decoration: none;
            border: 1px solid var(--border-subtle);
            padding: 8px 16px;
            border-radius: var(--radius-pill);
            transition: 0.3s;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.02);
            width: auto;
        }

        .home-link:hover {
            color: var(--text-primary);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.05);
        }

        /* Steps System */
        .step {
            display: none;
            animation: fadeIn 0.4s ease forwards;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            margin-top: 16px;
            padding: 12px;
            border-radius: var(--radius-md);
            font-size: 14px;
            display: none;
        }

        .message.error {
            display: block;
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .message.success {
            display: block;
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .otp-inputs {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .otp-inputs input {
            width: 50px;
            height: 60px;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            padding: 0;
            margin-bottom: 0;
            border-radius: var(--radius-md);
        }

        /* Hide number arrows */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        /* --- RESPONSIVE DESIGN --- */
        @media (max-width: 1024px) {
            .box {
                max-width: 440px;
                padding: 48px 40px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
                background-attachment: scroll;
            }

            .ambient-shape-1,
            .ambient-shape-2 {
                display: none;
            }

            .box {
                padding: 40px 24px;
                border-radius: 20px;
            }

            h2 {
                font-size: 28px;
                margin-bottom: 24px;
            }

            .subtitle {
                font-size: 14px;
            }

            input {
                padding: 14px 16px;
                font-size: 14px;
            }

            button {
                padding: 14px;
                font-size: 15px;
            }

            .otp-inputs {
                gap: 8px;
            }

            .otp-inputs input {
                width: 45px;
                height: 55px;
                font-size: 22px;
            }
        }

        @media(max-width: 480px) {
            body {
                padding: 16px;
                align-items: center;
                justify-content: center;
            }

            .box {
                padding: 32px 20px;
                border: 1px solid var(--border-subtle);
                background: rgba(15, 23, 42, 0.7);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                height: auto;
                display: block;
                border-radius: var(--radius-lg);
            }

            h2 {
                font-size: 26px;
                margin-bottom: 20px;
            }

            .otp-inputs {
                gap: 6px;
                margin: 24px 0;
            }

            .otp-inputs input {
                width: 40px;
                height: 50px;
                font-size: 20px;
                border-radius: 8px;
            }

            .home-link {
                margin-top: 24px;
                width: fit-content;
                align-self: center;
            }
        }
    </style>
</head>

<body>
    <button class="theme-toggle" id="themeToggleBtn" onclick="toggleTheme()" title="Toggle Theme">
        <i class="fas fa-sun"></i>
    </button>
    <div class="ambient-shape-1"></div>
    <div class="ambient-shape-2"></div>

    <div class="box">

        <!-- STEP 1: Email Input -->
        <div id="step1" class="step active">
            <h2><i>Reset</i> Password</h2>
            <p class="subtitle" style="margin-top: -10px;">Enter your email to receive an OTP</p>

            <div id="msg1" class="message"></div>

            <div class="input-group">
                <input type="email" id="resetEmail" placeholder="Enter your email address">
            </div>

            <button id="btnStep1" onclick="sendOtp()">
                <span id="textStep1">Send OTP</span>
                <div id="loader1" class="loader"></div>
            </button>
            <a href="login.html" class="home-link"><i class="fas fa-arrow-left"></i> Back to Login</a>
        </div>

        <!-- STEP 2: OTP Verification -->
        <div id="step2" class="step">
            <h2><i>Verify</i> OTP</h2>
            <p class="subtitle" style="margin-top: -10px;">Enter the 6-digit code sent to <br><b id="displayEmail"
                    style="color:white"></b></p>

            <div id="msg2" class="message"></div>

            <div class="otp-inputs" id="otpContainer">
                <input type="number" class="otp-box" maxlength="1" onkeyup="moveToNext(this, event)">
                <input type="number" class="otp-box" maxlength="1" onkeyup="moveToNext(this, event)">
                <input type="number" class="otp-box" maxlength="1" onkeyup="moveToNext(this, event)">
                <input type="number" class="otp-box" maxlength="1" onkeyup="moveToNext(this, event)">
                <input type="number" class="otp-box" maxlength="1" onkeyup="moveToNext(this, event)">
                <input type="number" class="otp-box" maxlength="1" onkeyup="moveToNext(this, event)">
            </div>

            <button id="btnStep2" onclick="verifyOtp()">
                <span id="textStep2">Verify Code</span>
                <div id="loader2" class="loader"></div>
            </button>

            <p style="margin-top: 24px;">Didn't receive code? <a href="#" onclick="resendOtp()">Resend</a></p>
        </div>

        <!-- STEP 3: New Password -->
        <div id="step3" class="step">
            <h2><i>New</i> Password</h2>
            <p class="subtitle" style="margin-top: -10px;">Create a new secure password</p>

            <div id="msg3" class="message"></div>

            <div class="input-group">
                <input type="password" id="newPassword" placeholder="New Password">
            </div>
            <div class="input-group">
                <input type="password" id="confirmPassword" placeholder="Confirm Password">
            </div>

            <button id="btnStep3" onclick="updatePassword()">
                <span id="textStep3">Confirm Password</span>
                <div id="loader3" class="loader"></div>
            </button>
        </div>

    </div>

    <script>
        let currentEmail = "";

        // Helper to show messages
        function showMessage(id, text, type) {
            const el = document.getElementById(id);
            el.textContent = text;
            el.className = 'message ' + type;
        }

        // Helper to set loading state
        function setLoading(stepNum, isLoading) {
            const btn = document.getElementById(`btnStep${stepNum}`);
            const text = document.getElementById(`textStep${stepNum}`);
            const loader = document.getElementById(`loader${stepNum}`);

            if (isLoading) {
                btn.disabled = true;
                text.style.display = 'none';
                loader.style.display = 'block';
            } else {
                btn.disabled = false;
                text.style.display = 'block';
                loader.style.display = 'none';
            }
        }

        // Initialize theme on load
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
            const themeBtnIcon = document.querySelector('#themeToggleBtn i');

            if (savedTheme === 'light' || (!savedTheme && prefersLight)) {
                document.documentElement.classList.add('light-theme');
                if (themeBtnIcon) {
                    themeBtnIcon.classList.remove('fa-sun');
                    themeBtnIcon.classList.add('fa-moon');
                }
            }
        }

        function toggleTheme() {
            const htmlEl = document.documentElement;
            const themeBtnIcon = document.querySelector('#themeToggleBtn i');

            if (htmlEl.classList.contains('light-theme')) {
                htmlEl.classList.remove('light-theme');
                localStorage.setItem('theme', 'dark');
                if (themeBtnIcon) {
                    themeBtnIcon.classList.remove('fa-moon');
                    themeBtnIcon.classList.add('fa-sun');
                }
            } else {
                htmlEl.classList.add('light-theme');
                localStorage.setItem('theme', 'light');
                if (themeBtnIcon) {
                    themeBtnIcon.classList.remove('fa-sun');
                    themeBtnIcon.classList.add('fa-moon');
                }
            }
        }

        // Step 1: Send OTP
        async function sendOtp() {
            const email = document.getElementById('resetEmail').value.trim().toLowerCase();
            if (!email) {
                showMessage('msg1', 'Please enter your email', 'error');
                return;
            }

            setLoading(1, true);

            try {
                // 1. Check if user exists
                const { data: user, error: userError } = await window.supabaseClient
                    .from('users')
                    .select('id, name')
                    .eq('email', email)
                    .single();

                if (userError) {
                    throw new Error(`Supabase Error (${userError.code}): ${userError.message}`);
                }

                if (!user) {
                    showMessage('msg1', 'Email not found in our system', 'error');
                    setLoading(1, false);
                    return;
                }

                // 2. Generate 6-digit OTP
                const otp = Math.floor(100000 + Math.random() * 900000).toString();

                // Set expiry to 10 minutes from now (PostgreSQL format)
                const expiresAt = new Date(new Date().getTime() + 10 * 60000).toISOString();

                // 3. Save OTP to DB
                const { error: updateError } = await window.supabaseClient
                    .from('users')
                    .update({
                        reset_otp: otp,
                        reset_otp_expires_at: expiresAt
                    })
                    .eq('email', email);

                if (updateError) throw updateError;

                currentEmail = email;

                // 4. Send Email via Express Backend API
                const response = await fetch(`${window.BACKEND_URL}/api/send-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp })
                });

                if (!response.ok) {
                    throw new Error('Failed to send OTP email');
                }

                // Transition to Step 2
                document.getElementById('displayEmail').textContent = email;
                document.getElementById('step1').classList.remove('active');
                document.getElementById('step2').classList.add('active');

            } catch (err) {
                console.error(err);
                showMessage('msg1', 'Error: ' + err.message, 'error');
            }

            setLoading(1, false);
        }

        async function resendOtp() {
            if (!currentEmail) return;
            const newOtp = Math.floor(100000 + Math.random() * 900000).toString();

            // 1. Update DB First
            await window.supabaseClient
                .from('users')
                .update({
                    reset_otp: newOtp,
                    reset_otp_expires_at: new Date(new Date().getTime() + 10 * 60000).toISOString()
                })
                .eq('email', currentEmail);

            try {
                // 2. Resend via API
                const response = await fetch(`${window.BACKEND_URL}/api/send-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentEmail, otp: newOtp })
                });

                if (!response.ok) throw new Error('Failed');

                showMessage('msg2', 'OTP Resent successfully!', 'success');
            } catch (err) {
                showMessage('msg2', 'Failed to resend OTP.', 'error');
            }
        }

        // OTP Input Auto-advance logic
        function moveToNext(current, event) {
            // Only allow numbers
            current.value = current.value.replace(/[^0-9]/g, '');

            if (current.value.length >= 1) {
                const next = current.nextElementSibling;
                if (next) next.focus();
            }

            // Handle Backspace
            if (event.key === "Backspace" && current.value === "") {
                const prev = current.previousElementSibling;
                if (prev) {
                    prev.focus();
                    prev.value = ""; // Clear previous on backtrack
                }
            }
        }

        // Step 2: Verify OTP
        async function verifyOtp() {
            const inputs = document.querySelectorAll('.otp-box');
            let enteredOtp = '';
            inputs.forEach(input => enteredOtp += input.value);

            if (enteredOtp.length !== 6) {
                showMessage('msg2', 'Please enter all 6 digits', 'error');
                return;
            }

            setLoading(2, true);

            try {
                // Fetch user OTP
                const { data: user, error } = await window.supabaseClient
                    .from('users')
                    .select('reset_otp, reset_otp_expires_at')
                    .eq('email', currentEmail)
                    .single();

                if (error) throw error;

                // Validate
                if (user.reset_otp !== enteredOtp) {
                    showMessage('msg2', 'Invalid code. Please try again.', 'error');
                } else if (new Date() > new Date(user.reset_otp_expires_at)) {
                    showMessage('msg2', 'Code has expired. Please request a new one.', 'error');
                } else {
                    // Success!
                    document.getElementById('step2').classList.remove('active');
                    document.getElementById('step3').classList.add('active');
                }

            } catch (err) {
                console.error(err);
                showMessage('msg2', 'Error verifying code.', 'error');
            }

            setLoading(2, false);
        }

        // Step 3: Update Password
        async function updatePassword() {
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;

            if (!newPass) {
                showMessage('msg3', 'Please enter a new password', 'error');
                return;
            }

            if (newPass !== confirmPass) {
                showMessage('msg3', 'Passwords do not match', 'error');
                return;
            }

            setLoading(3, true);

            try {
                // 1. Get user name for the email
                const { data: userData } = await window.supabaseClient
                    .from('users')
                    .select('name')
                    .eq('email', currentEmail)
                    .single();

                // 2. Update password and clear OTP
                const { error } = await window.supabaseClient
                    .from('users')
                    .update({
                        password: newPass,
                        reset_otp: null,
                        reset_otp_expires_at: null
                    })
                    .eq('email', currentEmail);

                if (error) throw error;

                // 3. Send Confirmation Email via Express Backend
                try {
                    await fetch(`${window.BACKEND_URL}/api/send-confirmation`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: currentEmail,
                            name: userData?.name || 'User'
                        })
                    });
                } catch (e) {
                    console.error('Non-fatal error: Failed to send confirmation email', e);
                }

                showMessage('msg3', 'Password updated! Redirecting to login...', 'success');

                // Wait 2 seconds then redirect to login
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);

            } catch (err) {
                console.error(err);
                showMessage('msg3', 'Failed to update password.', 'error');
                setLoading(3, false);
            }
        }

        initTheme();
    </script>
</body>

</html>